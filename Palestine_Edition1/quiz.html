<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flags Checking - Domanda Casuale</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        #quiz-container {
            max-width: 500px;
            width: 100%;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #card-header {
            background-color: #DDEEFF; 
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }
        #question-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        .answer-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: left;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .answer-button:hover:not(:disabled) {
            background-color: #e9e9e9;
        }
        #feedback {
            margin-top: 25px;
            padding: 10px;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            border-radius: 5px;
        }
        #next-button, #start-button, #reset-button, #reset-final-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #next-button:hover, #start-button:hover, #reset-button:hover, #reset-final-button:hover {
            background-color: #0056b3;
        }
        .correct-answer {
            background-color: #d4edda !important; 
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .incorrect-answer {
            background-color: #f8d7da !important; 
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        /* Nascondi il contenuto del quiz all'inizio */
        #quiz-content {
            display: none;
        }
        #welcome-screen {
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="quiz-container">
        
        <div id="welcome-screen">
            <h1>Flags Checking Quiz - Palestina Edition</h1>
            <div class="input-group">
                <label for="playerName">Inserisci il tuo nome:</label>
                <input type="text" id="playerName" placeholder="Nome team" maxlength="30">
            </div>
            <button id="start-button">Inizia la Partita</button>
        </div>

        <div id="quiz-content">
            <div id="card-header"></div>
            <p id="question-text"></p>

            <div id="options-container">
                <button type="button" class="answer-button" data-answer="A"></button>
                <button type="button" class="answer-button" data-answer="B"></button>
                <button type="button" class="answer-button" data-answer="C"></button>
                <button type="button" class="answer-button" data-answer="D"></button>
            </div>
            
            <div id="feedback"></div>
            <p id="progress-info" style="margin-top: 15px; text-align: center; font-size: 14px; color: #555;"></p>
            <button id="next-button" style="display: none;">Prossima Domanda Casuale</button>
            <button id="reset-button" style="background-color: #dc3545; margin-top: 10px; display: none;">Ricomincia Partita</button>
        </div>
        
        <div id="results" style="margin-top: 20px; text-align: center; font-weight: bold;">Punteggio: 0 su 0</div>

    </div>
    
    <script src="quizData.js"></script> 
    
    <script>
        // =========================================================================
        // Logica JavaScript del Quiz
        // =========================================================================

        // Verifica se quizData √® definito dal file quizData.js
        if (typeof quizData === 'undefined') {
            console.error("Errore: Il file quizData.js non √® stato caricato correttamente o non contiene la variabile quizData.");
        }

        // Variabili di Stato
        let askedQuestions = [];   // IDs delle domande gi√† poste
        let currentQuestion = null; // Domanda corrente
        let score = 0;              // Punteggio totale
        let totalAttempts = 0;      // Tentativi totali
        let playerName = 'Giocatore';

        // Riferimenti agli Elementi DOM
        const welcomeScreen = document.getElementById('welcome-screen');
        const quizContent = document.getElementById('quiz-content');
        const startButton = document.getElementById('start-button');
        const playerNameInput = document.getElementById('playerName');
        const cardHeader = document.getElementById('card-header');
        const questionTextElement = document.getElementById('question-text');
        // Riferimento corretto a tutti i pulsanti di risposta
        const answerButtons = document.querySelectorAll('#options-container .answer-button'); 
        const feedbackElement = document.getElementById('feedback');
        const nextButton = document.getElementById('next-button');
        const resetButton = document.getElementById('reset-button');
        const resultsElement = document.getElementById('results');

        // -------------------------------------------------------------------------
        // 1. FUNZIONE DI INIZIALIZZAZIONE E AVVIO
        // -------------------------------------------------------------------------

        function initializeQuiz() {
            // Nasconde il contenuto del quiz e mostra la schermata di benvenuto
            quizContent.style.display = 'none';
            welcomeScreen.style.display = 'block';
            resultsElement.textContent = `Punteggio: 0 su 0`;
            
            // Resetta le variabili di stato
            askedQuestions = [];
            score = 0;
            totalAttempts = 0;
            
            nextButton.style.display = 'none';
            resetButton.style.display = 'none';
            feedbackElement.textContent = '';
            
            // Ripristina l'HTML iniziale della welcome screen per evitare l'endGame
            welcomeScreen.innerHTML = `
                <h1>Flags Checking Quiz - Palestina Edition</h1>
		<div id="spotify-link" style="margin-bottom: 20px; padding: 15px; border: 1px dashed #4CAF50; border-radius: 5px; background-color: #e8f5e9;">
        <p style="margin: 0; font-weight: bold; color: #388e3c;">üéß Musica di Sottofondo</p>
        <p style="margin: 5px 0 0 0; font-size: 14px;">
            Per motivi di sicurezza, la playlist si aprir√† in una nuova finestra.
        </p>
        <a href="https://open.spotify.com/playlist/0SGifca2LtRBDsU5DktQly" 
           target="_blank" 
           style="display: inline-block; margin-top: 10px; padding: 8px 15px; background-color: #1DB954; color: white; text-decoration: none; border-radius: 4px;">
           Apri Playlist Spotify
        </a>
    </div>
                <div class="input-group">
                    <label for="playerName">Inserisci il nome della partita:</label>
                    <input type="text" id="playerName" placeholder="Nome team" maxlength="30" value="${playerNameInput.value || ''}">
                </div>
                <button id="start-button">Inizia la Partita</button>
            `;
            // Riassegna l'evento al nuovo pulsante "Inizia la Partita"
            document.getElementById('start-button').addEventListener('click', startQuiz);
            
            // Riassegna il riferimento all'input se necessario
            // Nota: in questo caso non serve perch√© stiamo per ricaricare la pagina per un reset completo
        }

        function startQuiz() {
            // Rilegge il nome dal campo input che potrebbe essere stato ricreato/aggiornato
            const currentNameInput = document.getElementById('playerName');
            playerName = currentNameInput ? (currentNameInput.value.trim() || 'Giocatore') : 'Giocatore';
            
            if (playerName.length < 2) {
                alert('Per favore, inserisci un nome valido di almeno 2 caratteri.');
                return;
            }

            // Passa alla schermata del quiz
            welcomeScreen.style.display = 'none';
            quizContent.style.display = 'block';
            resetButton.style.display = 'block';
            
            loadNextQuestion();
        }

        // -------------------------------------------------------------------------
        // 2. LOGICA DOMANDA
        // -------------------------------------------------------------------------

        function loadNextQuestion() {
            // Filtra le domande non ancora poste
            const availableQuestions = quizData.filter(q => !askedQuestions.includes(q.id));

            if (availableQuestions.length === 0) {
                endGame();
                return;
            }

            // Sceglie una domanda casuale tra quelle disponibili
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            currentQuestion = availableQuestions[randomIndex];

            // Resetta l'interfaccia
            feedbackElement.textContent = '';
            nextButton.style.display = 'none';
            
            // Riabilita e resetta i pulsanti
            answerButtons.forEach((button, index) => {
                button.disabled = false;
                button.classList.remove('correct-answer', 'incorrect-answer');
                
                // Assegna il testo della risposta
                if (index < currentQuestion.opzioni.length) {
                    button.textContent = currentQuestion.opzioni[index];
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none'; // Nasconde se ci sono meno di 4 opzioni
                }
            });

            // Aggiorna il testo e l'header
            cardHeader.textContent = `Categoria: ${currentQuestion.categoria} | Livello: ${currentQuestion.difficolt√†} | Domanda n. ${askedQuestions.length + 1}`;
            questionTextElement.textContent = currentQuestion.testo;
        }

        // -------------------------------------------------------------------------
        // 3. GESTIONE RISPOSTA
        // -------------------------------------------------------------------------

        function handleAnswer(event) {
            // Previene l'azione se il pulsante √® disabilitato
            if (event.target.disabled) return; 

            const selectedAnswer = event.target.getAttribute('data-answer');
            const correctKey = currentQuestion.corretta;
            
            // Disabilita tutti i pulsanti di risposta
            answerButtons.forEach(button => {
                button.disabled = true;
            });

            totalAttempts++;
            askedQuestions.push(currentQuestion.id);

            if (selectedAnswer === correctKey) {
                score++;
                event.target.classList.add('correct-answer');
                feedbackElement.textContent = `Corretto! üéâ`;
            } else {
                event.target.classList.add('incorrect-answer');
                // Evidenzia la risposta corretta
                const correctButton = Array.from(answerButtons).find(btn => btn.getAttribute('data-answer') === correctKey);
                if (correctButton) {
                    correctButton.classList.add('correct-answer');
                }
                feedbackElement.textContent = `Sbagliato. La risposta corretta era ${correctKey}.`;
            }
            
            // Aggiorna il punteggio e mostra il pulsante "Prossima"
            resultsElement.textContent = `Punteggio: ${score} su ${totalAttempts}`;
            nextButton.style.display = 'block';
        }


        // -------------------------------------------------------------------------
        // 4. FINE PARTITA
        // -------------------------------------------------------------------------

        function endGame() {
            quizContent.style.display = 'none';
            // Non mostra la welcome screen per non sovrascrivere i risultati
            welcomeScreen.style.display = 'block'; 

            let finalMessage = `Partita Terminata, ${playerName}! üèÅ\n`;
            finalMessage += `Hai risposto a tutte le domande disponibili (${totalAttempts}).\n`;
            
            let percentage = (totalAttempts > 0) ? ((score / totalAttempts) * 100).toFixed(1) : 0;
            finalMessage += `Punteggio Finale: ${score} su ${totalAttempts} (${percentage}%)`;
            
            // Sostituisce il contenuto della welcome screen con il risultato finale
            welcomeScreen.innerHTML = `
                <h1>Risultati Finali</h1>
                <p style="font-size: 1.2em; white-space: pre-line;">${finalMessage}</p>
                <button id="reset-final-button">Ricomincia</button>
            `;
            
            // Riassegna l'evento al nuovo pulsante "Ricomincia"
            document.getElementById('reset-final-button').addEventListener('click', () => {
                // Un semplice ricaricamento di pagina √® il modo pi√π pulito per resettare l'intero stato
                window.location.reload(); 
            });
        }


        // -------------------------------------------------------------------------
        // 5. LISTENER DI EVENTI
        // -------------------------------------------------------------------------

        // Avvio della partita (gestito nel window.onload in initializeQuiz)
        startButton.addEventListener('click', startQuiz);

        // Passaggio alla domanda successiva
        nextButton.addEventListener('click', loadNextQuestion);

        // Reset / Ricomincia
        resetButton.addEventListener('click', () => {
             // Un semplice ricaricamento di pagina √® il modo pi√π pulito
             window.location.reload(); 
        });

        // Gestione click sui pulsanti di risposta
        answerButtons.forEach(button => {
            button.addEventListener('click', handleAnswer);
        });


        // -------------------------------------------------------------------------
        // 6. AVVIO INIZIALE
        // -------------------------------------------------------------------------

        // Avvia l'interfaccia iniziale al caricamento della pagina
        window.onload = initializeQuiz;
    </script>
</body>
</html>